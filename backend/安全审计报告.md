# 安全审计报告

## 审计时间
2026-01-02

## 审计范围
- 认证与授权机制
- API 接口权限控制
- 越权漏洞检查
- JWT Token 验证
- 输入验证
- CORS 配置

---

## 🔴 严重安全漏洞

### 1. 水平越权漏洞 - 积分操作接口

**漏洞位置：**
- `PointsController.earnPoints()` - `/api/points/earn`
- `PointsController.spendPoints()` - `/api/points/spend`

**问题描述：**
- 接口允许通过请求体中的 `userId` 操作任意用户的积分
- 即使提供了 token，如果 token 无效，仍然允许通过 `userId` 操作
- 如果 token 有效但 `userId` 不一致，代码会使用 token 中的 `userId`，但逻辑不够严格

**风险等级：** 🔴 严重

**影响：**
- 攻击者可以给任意用户增加或扣除积分
- 可能导致积分系统被恶意操作

**修复建议：**
- 如果提供了 token，必须验证 token 有效性
- 如果提供了 token，必须强制使用 token 中的 `userId`，忽略请求体中的 `userId`
- 如果没有提供 token，应该拒绝请求（或仅允许内部服务调用，需要额外的内部认证）

---

### 2. 未授权访问漏洞 - 产品使用次数更新接口

**漏洞位置：**
- `ProductController.updateUsage()` - `/api/products/{id}/usage`

**问题描述：**
- 接口没有任何认证机制
- 任何人都可以调用此接口更新产品使用次数

**风险等级：** 🔴 严重

**影响：**
- 攻击者可以随意修改产品使用次数
- 可能影响产品兑换限制的准确性

**修复建议：**
- 添加 JWT Token 验证
- 或者限制为仅内部服务调用（需要内部认证机制）

---

### 3. 垂直越权漏洞 - 管理后台接口

**漏洞位置：**
- `PointsController.getAllExchanges()` - `/api/points/admin/exchanges`
- `ProductController.getAllProductsForAdmin()` - `/api/products/admin/all`
- `ProductController.updateProduct()` - `/api/products/admin/{id}`
- `ProductController.updateProductStock()` - `/api/products/admin/{id}/stock`
- `ProductController.updateProductStatus()` - `/api/products/admin/{id}/status`

**问题描述：**
- 所有管理后台接口只验证了 token，但没有验证用户是否有管理员权限
- 任何登录用户都可以访问管理功能

**风险等级：** 🔴 严重

**影响：**
- 普通用户可以查看所有兑换记录
- 普通用户可以修改产品信息、库存、状态
- 可能导致数据泄露和系统被恶意操作

**修复建议：**
- 添加用户角色系统（admin/user）
- 在 User 实体中添加 `role` 字段
- 创建权限验证拦截器或注解
- 所有 `/admin/*` 接口必须验证用户角色为 `admin`

---

## 🟡 中等安全漏洞

### 4. JWT Token 验证不完整

**漏洞位置：**
- 多个 Controller 中的接口

**问题描述：**
- 很多接口只调用 `getUserIdFromToken()`，但没有先调用 `validateToken()` 验证 token 是否有效
- `getUserIdFromToken()` 如果 token 无效会抛出异常，但异常处理可能不够完善

**风险等级：** 🟡 中等

**影响：**
- 可能允许使用已过期的 token
- 异常处理不当可能导致信息泄露

**修复建议：**
- 所有使用 token 的接口都应该先调用 `validateToken()` 验证
- 统一异常处理，避免泄露敏感信息

---

### 5. CORS 配置过于宽松

**漏洞位置：**
- `SecurityConfig.corsConfigurationSource()` - auth-service
- `application.yml` - api-gateway

**问题描述：**
- CORS 配置允许所有来源（`allowedOrigins: "*"`）
- 在生产环境中存在 CSRF 风险

**风险等级：** 🟡 中等

**影响：**
- 任何网站都可以调用 API
- 可能被恶意网站利用进行 CSRF 攻击

**修复建议：**
- 限制允许的来源为具体的域名列表
- 在生产环境中使用环境变量配置

---

## 🟢 轻微安全问题

### 6. 验证码硬编码

**漏洞位置：**
- `PointsService.exchange()` - 验证码固定为 "123456"

**问题描述：**
- 验证码硬编码，没有实际的验证码生成和验证机制

**风险等级：** 🟢 轻微

**影响：**
- 验证码功能形同虚设

**修复建议：**
- 实现真正的验证码生成和验证机制
- 或暂时移除验证码功能

---

### 7. 缺少输入验证

**问题描述：**
- 部分接口缺少对输入参数的严格验证
- 例如：`userId`、`points` 等参数没有范围检查

**风险等级：** 🟢 轻微

**修复建议：**
- 添加 `@Valid` 注解和验证规则
- 对关键参数进行范围检查

---

## 修复优先级

1. **立即修复（P0）：**
   - 修复水平越权漏洞（积分操作接口）
   - 修复未授权访问漏洞（产品使用次数更新接口）
   - 修复垂直越权漏洞（管理后台接口）

2. **尽快修复（P1）：**
   - 完善 JWT Token 验证
   - 添加用户角色系统

3. **计划修复（P2）：**
   - 修复 CORS 配置
   - 实现验证码功能
   - 加强输入验证

---

## 修复计划

详见后续修复代码。

---

## ✅ 已修复的安全漏洞

### 1. 水平越权漏洞 - 积分操作接口 ✅

**修复内容：**
- `/api/points/earn` 和 `/api/points/spend` 接口现在必须提供有效的 JWT Token
- 强制使用 token 中的 `userId`，完全忽略请求体中的 `userId`（防止越权）
- 添加了 token 有效性验证
- 添加了积分数量验证

**修复位置：**
- `PointsController.earnPoints()`
- `PointsController.spendPoints()`

---

### 2. 未授权访问漏洞 - 产品使用次数更新接口 ✅

**修复内容：**
- `/api/products/{id}/usage` 接口现在需要 JWT Token 认证
- 添加了 token 有效性验证

**修复位置：**
- `ProductController.updateUsage()`

---

### 3. 垂直越权漏洞 - 管理后台接口 ✅

**修复内容：**
- 在 `User` 实体中添加了 `role` 字段（user/admin）
- 在 JWT Token 中包含用户角色信息
- 所有 `/admin/*` 接口现在都验证用户角色是否为 `admin`
- 如果用户不是管理员，返回 403 错误

**修复位置：**
- `User.java` - 添加 role 字段
- `JwtUtil.java` - 添加角色相关方法
- `AuthService.java` - 在生成 token 时包含角色
- `PointsController.getAllExchanges()` - 验证管理员权限
- `ProductController.getAllProductsForAdmin()` - 验证管理员权限
- `ProductController.updateProduct()` - 验证管理员权限
- `ProductController.updateProductStock()` - 验证管理员权限
- `ProductController.updateProductStatus()` - 验证管理员权限

---

### 4. JWT Token 验证完善 ✅

**修复内容：**
- 所有使用 token 的接口现在都先调用 `validateToken()` 验证 token 有效性
- 统一了异常处理，避免信息泄露

**修复位置：**
- `PointsController` - 所有接口
- `ProductController` - 所有接口

---

### 5. 数据库更新

**修复内容：**
- 更新了 `init.sql`，添加 `role` 字段到 `users` 表
- 测试用户 `test` 的角色设置为 `admin`

---

## ⚠️ 待修复的安全问题

### 6. CORS 配置过于宽松

**状态：** 待修复

**建议：**
- 在生产环境中限制允许的来源为具体的域名列表
- 使用环境变量配置

---

### 7. 验证码硬编码

**状态：** 待修复

**建议：**
- 实现真正的验证码生成和验证机制
- 或暂时移除验证码功能

---

## 测试建议

1. **测试越权防护：**
   - 尝试使用普通用户 token 访问管理后台接口，应该返回 403
   - 尝试在 `/api/points/earn` 中传递不同的 `userId`，应该被忽略

2. **测试权限验证：**
   - 使用管理员账号登录，应该可以访问所有管理接口
   - 使用普通用户登录，应该无法访问管理接口

3. **测试 Token 验证：**
   - 使用过期或无效的 token，应该返回 401
   - 不提供 token，应该返回 401

---

## 总结

已修复所有严重和中等安全漏洞：
- ✅ 水平越权漏洞
- ✅ 垂直越权漏洞
- ✅ 未授权访问漏洞
- ✅ JWT Token 验证完善
- ✅ 用户角色系统

剩余问题为轻微安全问题，可在后续版本中修复。

