# 后端系统启动指南

## 环境要求

- JDK 17 或更高版本
- Maven 3.6+
- MySQL 8.0+
- Redis 6.0+ (可选，用于缓存)

## 快速开始

### 1. 数据库准备

#### 1.1 创建数据库
```sql
CREATE DATABASE points_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 1.2 执行初始化脚本
```bash
mysql -u root -p points_system < backend/database/init.sql
```

或者直接在MySQL客户端中执行 `backend/database/init.sql` 文件。

### 2. 配置数据库连接

修改各服务的 `application.yml` 文件中的数据库配置：

**auth-service/src/main/resources/application.yml**
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/points_system?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root  # 修改为你的数据库用户名
    password: root  # 修改为你的数据库密码
```

同样修改以下文件：
- `points-service/src/main/resources/application.yml`
- `product-service/src/main/resources/application.yml`

### 3. 编译公共模块

首先需要编译 common 模块，因为其他服务依赖它：

```bash
cd backend/common
mvn clean install
```

### 4. 启动服务

**注意：启动顺序很重要！**

#### 方式一：分别启动（推荐用于开发）

**终端1 - 启动认证服务**
```bash
cd backend/auth-service
mvn spring-boot:run
```
服务将在 `http://localhost:8081` 启动

**终端2 - 启动积分服务**
```bash
cd backend/points-service
mvn spring-boot:run
```
服务将在 `http://localhost:8082` 启动

**终端3 - 启动产品服务**
```bash
cd backend/product-service
mvn spring-boot:run
```
服务将在 `http://localhost:8083` 启动

**终端4 - 启动API网关**
```bash
cd backend/api-gateway
mvn spring-boot:run
```
服务将在 `http://localhost:8080` 启动

#### 方式二：使用IDE启动

1. 在IDE中分别打开各个服务的启动类：
   - `AuthServiceApplication`
   - `PointsServiceApplication`
   - `ProductServiceApplication`
   - `GatewayApplication`

2. 按顺序运行它们

### 5. 验证服务

#### 5.1 测试登录接口
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}'
```

预期响应：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "...",
    "refreshToken": "...",
    "expiresIn": 86400000,
    "userInfo": {
      "userId": 1,
      "username": "test",
      "nickname": "测试用户"
    }
  }
}
```

#### 5.2 测试获取产品列表
```bash
curl http://localhost:8080/api/products
```

#### 5.3 测试获取积分余额（需要先登录获取token）
```bash
# 先登录获取token
TOKEN=$(curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}' | jq -r '.data.token')

# 使用token获取积分余额
curl http://localhost:8080/api/points/balance \
  -H "Authorization: Bearer $TOKEN"
```

## 服务端口说明

| 服务 | 端口 | 说明 |
|------|------|------|
| API Gateway | 8080 | 统一入口，所有请求通过网关 |
| Auth Service | 8081 | 认证服务 |
| Points Service | 8082 | 积分服务 |
| Product Service | 8083 | 产品服务 |

## 默认测试账号

- 用户名: `test`
- 密码: `123456`
- 初始积分: `1250`

## 常见问题

### 1. 编译错误：找不到 common 模块

**解决方案**：
```bash
cd backend/common
mvn clean install
```

### 2. 数据库连接失败

**检查项**：
- MySQL服务是否启动
- 数据库用户名密码是否正确
- 数据库 `points_system` 是否已创建
- 是否已执行初始化脚本

### 3. 服务启动失败：端口被占用

**解决方案**：
- 检查端口是否被其他程序占用
- 修改 `application.yml` 中的端口配置

### 4. JWT Token 验证失败

**检查项**：
- 确保所有服务的 `jwt.secret` 配置一致
- Token 是否过期（默认24小时）

### 5. 跨域问题

API网关已配置CORS，允许所有来源。如果仍有问题，检查：
- 前端请求的URL是否正确（应该是 `http://localhost:8080`）
- 请求头是否包含 `Authorization: Bearer {token}`

## 开发建议

1. **使用Postman或类似工具测试API**
   - 导入API接口文档中的接口进行测试

2. **查看日志**
   - 各服务的日志会输出到控制台
   - 可以通过日志查看详细的请求和响应信息

3. **数据库管理**
   - 建议使用数据库管理工具（如Navicat、DBeaver）查看数据
   - 可以通过SQL直接操作数据用于测试

4. **热部署**
   - 开发时可以使用Spring Boot DevTools实现热部署
   - 添加依赖后修改代码会自动重启

## 生产环境部署

生产环境部署时需要注意：

1. **配置管理**
   - 使用配置中心（如Nacos、Consul）
   - 敏感信息使用环境变量或密钥管理

2. **服务注册与发现**
   - 集成Eureka或Nacos作为注册中心
   - 使用负载均衡

3. **监控与日志**
   - 集成Spring Boot Actuator
   - 使用ELK或类似方案收集日志

4. **安全**
   - 启用HTTPS
   - 配置更严格的CORS策略
   - 使用更强的JWT密钥

5. **数据库**
   - 使用连接池
   - 配置读写分离
   - 定期备份

## 下一步

- 查看 [API接口文档](./API接口文档.md) 了解详细的接口说明
- 查看 [README.md](./README.md) 了解项目结构

