# 安全配置指南

## 概述

本指南说明如何安全地配置积分系统的后端服务，特别是生产环境的安全配置。

---

## 一、环境变量配置

### 1.1 配置模板

复制 `.env.example` 为 `.env` 并修改配置值：

```bash
cp .env.example .env
```

### 1.2 必须修改的配置项

以下配置项在生产环境**必须修改**：

| 配置项 | 说明 | 示例 |
|--------|------|------|
| `DB_PASSWORD` | 数据库密码 | 使用强密码，至少16位 |
| `JWT_SECRET` | JWT密钥 | 使用 `openssl rand -base64 64` 生成 |
| `CORS_ALLOWED_ORIGINS` | 允许的前端域名 | `https://your-domain.com` |
| `SPRING_PROFILES_ACTIVE` | 运行环境 | `prod` |

### 1.3 JWT密钥生成

```bash
# 生成256位随机密钥
openssl rand -base64 64

# 示例输出：
# K7gNU3sdo+OL0wNhqoVWhr3g6s1xYv72ol/pe/Unols=...
```

---

## 二、数据库安全

### 2.1 创建专用数据库用户

```sql
-- 创建只有必要权限的数据库用户
CREATE USER 'points_user'@'localhost' IDENTIFIED BY 'your_strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON points_system.* TO 'points_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2.2 启用SSL连接

1. 配置MySQL启用SSL：

```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
ssl-ca=/path/to/ca.pem
ssl-cert=/path/to/server-cert.pem
ssl-key=/path/to/server-key.pem
require_secure_transport=ON
```

2. 设置环境变量：

```bash
DB_SSL_ENABLED=true
```

---

## 三、CORS配置

### 3.1 生产环境配置

**必须配置具体的前端域名，不允许使用通配符 `*`**

```bash
# 正确配置
CORS_ALLOWED_ORIGINS=https://www.your-domain.com,https://admin.your-domain.com

# 错误配置（不安全）
CORS_ALLOWED_ORIGINS=*
```

### 3.2 多域名支持

如果有多个前端域名，用逗号分隔：

```bash
CORS_ALLOWED_ORIGINS=https://app.example.com,https://admin.example.com,https://m.example.com
```

---

## 四、验证码配置

### 4.1 开发环境

开发环境可以使用简单验证模式：

```bash
VERIFICATION_MODE=simple
VERIFICATION_TEST_CODE=123456
```

### 4.2 生产环境

**生产环境必须使用短信验证模式**：

```bash
VERIFICATION_MODE=sms
VERIFICATION_TEST_CODE=  # 留空
SMS_SERVICE_URL=https://your-sms-service.com/api
SMS_SERVICE_KEY=your_api_key
```

---

## 五、HTTPS配置

### 5.1 使用Nginx反向代理

推荐使用Nginx作为反向代理处理HTTPS：

```nginx
server {
    listen 443 ssl http2;
    server_name api.your-domain.com;

    ssl_certificate /path/to/fullchain.pem;
    ssl_certificate_key /path/to/privkey.pem;
    
    # 安全头配置
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 5.2 Let's Encrypt证书

使用免费的Let's Encrypt证书：

```bash
# 安装certbot
apt-get install certbot python3-certbot-nginx

# 获取证书
certbot --nginx -d api.your-domain.com
```

---

## 六、日志配置

### 6.1 生产环境日志级别

生产环境应使用较低的日志级别：

```bash
LOG_LEVEL=WARN
APP_LOG_LEVEL=INFO
```

### 6.2 日志安全

确保日志不记录敏感信息：
- 不记录密码
- 不记录完整的Token
- 不记录用户敏感数据

---

## 七、服务启动

### 7.1 使用环境变量启动

```bash
# 方式1：导出环境变量
export JWT_SECRET=your_secret
export DB_PASSWORD=your_password
java -jar auth-service.jar

# 方式2：使用.env文件
source .env
java -jar auth-service.jar

# 方式3：命令行参数
java -jar auth-service.jar \
  --jwt.secret=$JWT_SECRET \
  --spring.datasource.password=$DB_PASSWORD
```

### 7.2 Docker部署

```yaml
# docker-compose.yml
version: '3.8'
services:
  auth-service:
    image: points/auth-service
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_HOST=mysql
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
```

---

## 八、安全检查清单

### 部署前检查

- [ ] JWT_SECRET 已更改为强随机密钥
- [ ] DB_PASSWORD 已更改为强密码
- [ ] CORS_ALLOWED_ORIGINS 已配置为具体域名
- [ ] SPRING_PROFILES_ACTIVE 设置为 prod
- [ ] 数据库SSL连接已启用
- [ ] HTTPS已配置
- [ ] 日志级别已调整为生产级别
- [ ] 验证码模式已切换为SMS模式
- [ ] .env 文件未提交到版本控制

### 定期检查

- [ ] 依赖安全漏洞扫描（每周）
- [ ] 密钥轮换（每季度）
- [ ] 访问日志审计（每月）
- [ ] 渗透测试（每年）

---

## 九、常见问题

### Q: 如何生成强密码？

```bash
# 生成32位随机密码
openssl rand -base64 32
```

### Q: 如何检查依赖漏洞？

```bash
# Maven项目
mvn org.owasp:dependency-check-maven:check

# NPM项目
npm audit
```

### Q: 如何轮换JWT密钥？

1. 生成新密钥
2. 配置新密钥
3. 重启服务
4. 等待旧Token过期

---

## 十、联系方式

如有安全问题，请联系：
- 安全团队邮箱：security@example.com
- 紧急电话：xxx-xxxx-xxxx

