# 全面安全扫描报告

## 扫描时间
2026-01-02

## 扫描范围
- 后端服务（Spring Boot 微服务）
- 前端应用（React + Vue）
- 数据库配置
- 第三方依赖
- 配置文件

---

## 一、源代码安全检测

### 1.1 SQL注入漏洞检测

**检测结果：** ✅ 未发现SQL注入漏洞

**检测内容：**
- 使用 Spring Data JPA，所有查询都使用参数化查询
- 使用 `@Query` 注解的 JPQL 查询都使用 `@Param` 参数绑定
- 未发现字符串拼接SQL的情况

**代码示例：**
```java
@Query("SELECT COUNT(e) FROM ExchangeRecord e " +
       "WHERE e.userId = :userId " +
       "AND e.productId = :productId " +
       "AND YEAR(e.createdAt) = YEAR(:date) " +
       "AND MONTH(e.createdAt) = MONTH(:date)")
Integer countMonthlyExchanges(@Param("userId") Long userId, 
                               @Param("productId") Long productId,
                               @Param("date") LocalDateTime date);
```

**风险等级：** ✅ 安全

---

### 1.2 XSS（跨站脚本攻击）检测

**检测结果：** ⚠️ 需要关注

**检测内容：**
- 前端使用 React 和 Vue，默认有 XSS 防护
- 未发现使用 `dangerouslySetInnerHTML` 或 `innerHTML` 直接渲染用户输入
- 后端返回的数据未进行 HTML 转义（依赖前端框架）

**建议：**
- 后端 API 响应中添加 Content-Security-Policy 头
- 前端确保所有用户输入都经过转义

**风险等级：** 🟡 中等

---

### 1.3 代码注入检测

**检测结果：** ✅ 未发现代码注入漏洞

**检测内容：**
- 未发现使用 `eval()` 函数
- 未发现动态执行代码的情况
- 所有代码都是静态编译

**风险等级：** ✅ 安全

---

### 1.4 路径遍历漏洞检测

**检测结果：** ✅ 未发现路径遍历漏洞

**检测内容：**
- 文件操作都使用相对路径
- 未发现使用用户输入构建文件路径的情况

**风险等级：** ✅ 安全

---

### 1.5 硬编码敏感信息

**检测结果：** 🔴 发现硬编码敏感信息

**问题位置：**
1. **验证码硬编码：**
   ```java
   // PointsService.java:81
   if (!"123456".equals(request.getVerificationCode())) {
       throw new RuntimeException("验证码错误");
   }
   ```

2. **JWT Secret 硬编码：**
   ```yaml
   # application.yml
   jwt:
     secret: points-system-secret-key-for-jwt-token-generation-minimum-256-bits
   ```

3. **数据库密码硬编码：**
   ```yaml
   # application.yml
   spring:
     datasource:
       password: root
   ```

**风险等级：** 🔴 严重

**修复建议：**
- 使用环境变量或配置中心管理敏感信息
- 验证码应使用真正的验证码服务
- JWT Secret 应使用强随机密钥
- 数据库密码应使用加密存储

---

## 二、漏洞扫描

### 2.1 已知CVE漏洞检测

**检测结果：** ⚠️ 需要检查依赖版本

**检测内容：**
- Spring Boot 3.2.0（2023年发布，需要检查是否有安全更新）
- Spring Cloud 2023.0.0
- MySQL Connector/J（需要检查版本）
- JWT库 0.12.3（最新版本）

**建议：**
- 使用 `mvn dependency-check` 或 `npm audit` 检查依赖漏洞
- 定期更新依赖到最新安全版本

**风险等级：** 🟡 中等

---

### 2.2 配置漏洞

**检测结果：** 🔴 发现多个配置安全问题

**问题：**

1. **CSRF 保护被禁用：**
   ```java
   // SecurityConfig.java:28
   .csrf(csrf -> csrf.disable())
   ```
   - 虽然 REST API 通常不需要 CSRF，但应该明确说明原因

2. **CORS 配置过于宽松：**
   ```yaml
   # application.yml
   allowedOrigins: "*"
   allowedHeaders: "*"
   ```
   - 允许所有来源访问，存在 CSRF 风险

3. **数据库连接未使用SSL：**
   ```yaml
   # application.yml
   url: jdbc:mysql://localhost:3306/points_system?useSSL=false
   ```
   - 生产环境应启用 SSL

4. **Hibernate DDL 自动更新：**
   ```yaml
   # application.yml
   jpa:
     hibernate:
       ddl-auto: update
   ```
   - 生产环境应禁用，使用 Flyway 或 Liquibase

5. **SQL 日志开启：**
   ```yaml
   # application.yml
   jpa:
     show-sql: true
   ```
   - 可能泄露敏感信息

**风险等级：** 🔴 严重

---

### 2.3 信息泄露

**检测结果：** ⚠️ 发现信息泄露风险

**问题：**

1. **错误信息过于详细：**
   ```java
   // 多个地方
   throw new RuntimeException("用户名或密码错误");
   ```
   - 可能泄露用户存在性信息

2. **调试日志级别：**
   ```yaml
   logging:
     level:
       com.points: DEBUG
   ```
   - 生产环境不应使用 DEBUG 级别

3. **前端控制台日志：**
   ```typescript
   // api.ts:55
   console.log('API Response:', url, data);
   ```
   - 可能泄露敏感信息

**风险等级：** 🟡 中等

---

## 三、身份认证与授权检测

### 3.1 密码安全

**检测结果：** ✅ 密码使用 BCrypt 加密

**检测内容：**
- 使用 `BCryptPasswordEncoder` 进行密码加密
- 密码存储为哈希值，不存储明文
- 密码验证使用 `passwordEncoder.matches()`

**代码示例：**
```java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

**风险等级：** ✅ 安全

---

### 3.2 JWT Token 安全

**检测结果：** ⚠️ 部分安全问题

**检测内容：**

1. **Token 过期时间：**
   - Access Token: 24小时（86400000ms）
   - Refresh Token: 7天（604800000ms）
   - ✅ 过期时间合理

2. **Token 签名算法：**
   - 使用 HMAC-SHA512（`Keys.hmacShaKeyFor()`）
   - ✅ 算法安全

3. **Token 验证：**
   - ✅ 所有接口都验证 token 有效性
   - ✅ 验证 token 过期时间

4. **Token 存储：**
   - 前端使用 `localStorage` 存储 token
   - ⚠️ 存在 XSS 风险，建议使用 httpOnly cookie

5. **Token 刷新机制：**
   - ⚠️ 未实现 refresh token 刷新 access token 的逻辑

**风险等级：** 🟡 中等

---

### 3.3 权限控制

**检测结果：** ✅ 权限控制已实现

**检测内容：**
- ✅ 实现了基于角色的访问控制（RBAC）
- ✅ 所有管理接口都验证管理员权限
- ✅ 用户只能操作自己的数据（水平权限控制）
- ✅ 管理员权限验证通过 JWT token 中的 role 字段

**代码示例：**
```java
String role = jwtUtil.getRoleFromToken(actualToken);
if (role == null || !"admin".equals(role)) {
    return ApiResponse.error(403, "需要管理员权限");
}
```

**风险等级：** ✅ 安全

---

### 3.4 会话管理

**检测结果：** ✅ 使用无状态会话

**检测内容：**
- 使用 JWT token，无服务器端会话
- 配置为无状态会话：`SessionCreationPolicy.STATELESS`
- ✅ 符合微服务架构

**风险等级：** ✅ 安全

---

## 四、数据安全检测

### 4.1 敏感数据加密

**检测结果：** ⚠️ 部分数据未加密

**检测内容：**

1. **数据库连接：**
   - ⚠️ 未使用 SSL/TLS 加密
   - ⚠️ 密码明文存储在配置文件中

2. **数据传输：**
   - ⚠️ 未强制使用 HTTPS
   - API Gateway 未配置 SSL

3. **数据存储：**
   - ✅ 密码使用 BCrypt 加密
   - ⚠️ 其他敏感数据（如用户信息）未加密

**风险等级：** 🔴 严重

---

### 4.2 数据验证

**检测结果：** ⚠️ 部分输入验证不足

**检测内容：**

1. **后端验证：**
   - ✅ 使用 `@Valid` 注解进行输入验证
   - ✅ 使用 `@NotNull`, `@NotBlank` 等注解
   - ⚠️ 部分接口缺少参数范围验证（如积分数量、库存等）

2. **前端验证：**
   - ✅ 使用表单验证
   - ⚠️ 缺少服务端验证的二次确认

**风险等级：** 🟡 中等

---

### 4.3 数据访问控制

**检测结果：** ✅ 数据访问控制良好

**检测内容：**
- ✅ 用户只能访问自己的数据
- ✅ 管理员可以访问所有数据
- ✅ 使用 JWT token 中的 userId 进行数据隔离

**风险等级：** ✅ 安全

---

### 4.4 数据备份与恢复

**检测结果：** ⚠️ 未发现备份策略

**检测内容：**
- 未发现数据库备份脚本
- 未发现数据恢复流程
- 未发现灾难恢复计划

**风险等级：** 🟡 中等

---

## 五、配置安全检测

### 5.1 环境变量管理

**检测结果：** 🔴 未使用环境变量

**检测内容：**
- 所有配置都硬编码在 `application.yml` 中
- 未使用环境变量管理敏感配置
- 未区分开发、测试、生产环境配置

**问题配置：**
```yaml
spring:
  datasource:
    username: root
    password: root  # 硬编码密码

jwt:
  secret: points-system-secret-key-for-jwt-token-generation-minimum-256-bits  # 硬编码密钥
```

**风险等级：** 🔴 严重

---

### 5.2 日志配置

**检测结果：** ⚠️ 日志配置不安全

**检测内容：**
- 开启 SQL 日志：`show-sql: true`
- 使用 DEBUG 日志级别
- 可能记录敏感信息（密码、token等）

**风险等级：** 🟡 中等

---

### 5.3 错误处理

**检测结果：** ⚠️ 错误信息可能泄露信息

**检测内容：**
- 错误信息可能泄露系统内部信息
- 未统一错误处理机制
- 未过滤敏感错误信息

**风险等级：** 🟡 中等

---

### 5.4 端口和网络配置

**检测结果：** ⚠️ 网络配置需要优化

**检测内容：**
- 服务使用固定端口（8080, 8081, 8082, 8083）
- 未配置防火墙规则
- 未限制服务间通信

**风险等级：** 🟡 中等

---

## 六、第三方组件安全检测

### 6.1 后端依赖

**检测结果：** ⚠️ 需要检查依赖版本

**主要依赖：**
- Spring Boot: 3.2.0
- Spring Cloud: 2023.0.0
- MySQL Connector/J: 未指定版本（使用 Spring Boot 管理）
- JWT (jjwt): 0.12.3
- Lombok: 未指定版本

**建议：**
- 使用 `mvn dependency-check:check` 检查已知漏洞
- 定期更新依赖到最新安全版本
- 使用 `mvn versions:display-dependency-updates` 检查可更新版本

**风险等级：** 🟡 中等

---

### 6.2 前端依赖

**检测结果：** ⚠️ 需要检查依赖版本

**主要依赖（jifeng-front）：**
- React: 18.3.1
- Vite: 6.3.5
- 多个 @radix-ui 组件
- 多个 @mui 组件

**主要依赖（admin-frontend）：**
- Vue: ^3.4.0
- Element Plus: ^2.5.0
- Axios: ^1.6.0

**建议：**
- 使用 `npm audit` 检查已知漏洞
- 定期更新依赖到最新安全版本
- 使用 `npm outdated` 检查可更新版本

**风险等级：** 🟡 中等

---

### 6.3 依赖版本管理

**检测结果：** ⚠️ 部分依赖使用范围版本

**检测内容：**
- Vue: `^3.4.0`（允许小版本更新）
- Element Plus: `^2.5.0`（允许小版本更新）
- ⚠️ 可能导致意外的依赖更新

**建议：**
- 生产环境应锁定具体版本
- 使用 `package-lock.json` 和 `yarn.lock` 锁定版本

**风险等级：** 🟡 中等

---

## 安全风险总结

### 🔴 严重风险（必须立即修复）

1. **硬编码敏感信息**
   - 验证码硬编码
   - JWT Secret 硬编码
   - 数据库密码硬编码

2. **配置安全问题**
   - CSRF 保护被禁用
   - CORS 配置过于宽松
   - 数据库连接未使用 SSL
   - Hibernate DDL 自动更新

3. **数据加密不足**
   - 数据库连接未加密
   - 未强制使用 HTTPS

4. **环境变量管理缺失**
   - 未使用环境变量管理敏感配置

### 🟡 中等风险（建议尽快修复）

1. **XSS 防护**
   - 需要添加 Content-Security-Policy
   - Token 存储方式需要优化

2. **信息泄露**
   - 错误信息过于详细
   - 调试日志级别
   - 前端控制台日志

3. **输入验证**
   - 部分接口缺少参数范围验证

4. **依赖安全**
   - 需要检查依赖漏洞
   - 需要更新到最新安全版本

5. **数据备份**
   - 缺少备份策略

### ✅ 安全措施（已实现）

1. **SQL注入防护** - 使用参数化查询
2. **密码加密** - 使用 BCrypt
3. **权限控制** - 实现 RBAC
4. **Token 验证** - 完善的 JWT 验证机制
5. **数据访问控制** - 用户数据隔离

---

## 修复优先级建议

### P0（立即修复）
1. 移除硬编码敏感信息，使用环境变量
2. 启用数据库 SSL 连接
3. 限制 CORS 配置
4. 禁用生产环境的 DDL 自动更新

### P1（尽快修复）
1. 实现真正的验证码机制
2. 添加 HTTPS 支持
3. 优化错误信息，避免信息泄露
4. 检查并更新依赖漏洞

### P2（计划修复）
1. 实现 Token 刷新机制
2. 添加数据备份策略
3. 优化日志配置
4. 添加输入验证增强

---

## 安全最佳实践建议

1. **使用配置中心**（如 Spring Cloud Config、Nacos）
2. **使用密钥管理服务**（如 HashiCorp Vault、AWS Secrets Manager）
3. **启用 HTTPS**（使用 Let's Encrypt 或商业证书）
4. **实现 API 限流**（防止暴力破解和 DDoS）
5. **添加安全监控**（如异常登录检测、API 调用监控）
6. **定期安全审计**（建议每季度进行一次）
7. **建立安全开发流程**（代码审查、安全测试）
8. **实施最小权限原则**（每个服务只拥有必要的权限）

---

## 扫描工具建议

1. **依赖漏洞扫描：**
   - Maven: `mvn org.owasp:dependency-check-maven:check`
   - NPM: `npm audit`

2. **代码安全扫描：**
   - SonarQube
   - Checkmarx
   - Fortify

3. **配置安全扫描：**
   - OWASP Dependency-Check
   - Snyk

4. **渗透测试：**
   - OWASP ZAP
   - Burp Suite

---

## 附录：详细检查清单

### 源代码安全
- [x] SQL注入检测
- [x] XSS检测
- [x] 代码注入检测
- [x] 路径遍历检测
- [x] 硬编码敏感信息检测

### 漏洞扫描
- [x] CVE漏洞检测
- [x] 配置漏洞检测
- [x] 信息泄露检测

### 身份认证与授权
- [x] 密码安全检测
- [x] JWT Token安全检测
- [x] 权限控制检测
- [x] 会话管理检测

### 数据安全
- [x] 敏感数据加密检测
- [x] 数据验证检测
- [x] 数据访问控制检测
- [x] 数据备份检测

### 配置安全
- [x] 环境变量管理检测
- [x] 日志配置检测
- [x] 错误处理检测
- [x] 端口和网络配置检测

### 第三方组件
- [x] 后端依赖检测
- [x] 前端依赖检测
- [x] 依赖版本管理检测

---

**报告生成时间：** 2026-01-02  
**扫描范围：** 全项目  
**扫描深度：** 深度扫描

---

## 修复状态更新（2026-01-02）

### ✅ 已修复的严重安全漏洞

#### 1. 硬编码敏感信息 - 已修复

**修复内容：**
- 创建了 `.env.example` 环境变量配置模板
- 所有 `application.yml` 已改用环境变量引用
- 敏感配置（数据库密码、JWT密钥等）从配置文件中移除

**修复文件：**
- `backend/.env.example` - 配置模板
- `backend/auth-service/src/main/resources/application.yml`
- `backend/points-service/src/main/resources/application.yml`
- `backend/product-service/src/main/resources/application.yml`
- `backend/api-gateway/src/main/resources/application.yml`

#### 2. CORS配置过于宽松 - 已修复

**修复内容：**
- 移除通配符 `*` 配置
- 使用环境变量配置允许的前端域名
- 限制允许的请求头，仅允许必要的头
- 添加预检请求缓存配置

**修复文件：**
- `backend/auth-service/src/main/java/com/points/auth/config/SecurityConfig.java`
- `backend/api-gateway/src/main/resources/application.yml`

#### 3. 验证码硬编码 - 已修复

**修复内容：**
- 创建 `VerificationConfig` 配置类
- 支持两种验证模式：`simple`（开发）和 `sms`（生产）
- 开发环境使用环境变量配置测试验证码
- 生产环境强制使用短信验证

**修复文件：**
- `backend/points-service/src/main/java/com/points/points/config/VerificationConfig.java`
- `backend/points-service/src/main/java/com/points/points/service/PointsService.java`

#### 4. 生产/开发环境配置分离 - 已修复

**修复内容：**
- 使用 Spring Profiles 区分环境
- 开发环境：`ddl-auto: update`, `show-sql: true`, `LOG_LEVEL: DEBUG`
- 生产环境：`ddl-auto: validate`, `show-sql: false`, `LOG_LEVEL: WARN`

**配置使用：**
```bash
# 开发环境（默认）
SPRING_PROFILES_ACTIVE=dev

# 生产环境
SPRING_PROFILES_ACTIVE=prod
```

### 📋 待完成事项

1. **启用数据库SSL连接**
   - 需要配置MySQL SSL证书
   - 设置 `DB_SSL_ENABLED=true`

2. **配置HTTPS**
   - 推荐使用Nginx反向代理
   - 使用Let's Encrypt免费证书

3. **实现完整的短信验证码服务**
   - 集成短信服务商API
   - 使用Redis存储验证码

4. **依赖漏洞扫描**
   - 运行 `mvn dependency-check:check`
   - 运行 `npm audit`

### 📖 安全配置文档

详细的安全配置指南请参考：`backend/安全配置指南.md`


