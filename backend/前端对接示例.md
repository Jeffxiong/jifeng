# 前端对接示例

## 创建API服务文件

在项目中创建 `src/services/api.ts` 文件：

```typescript
const API_BASE_URL = 'http://localhost:8080';

// 获取Token
const getToken = (): string | null => {
  return localStorage.getItem('token');
};

// 设置Token
const setToken = (token: string): void => {
  localStorage.setItem('token', token);
};

// 移除Token
const removeToken = (): void => {
  localStorage.removeItem('token');
};

// 通用请求方法
const request = async <T>(
  url: string,
  options: RequestInit = {}
): Promise<T> => {
  const token = getToken();
  const headers: HeadersInit = {
    'Content-Type': 'application/json',
    ...options.headers,
  };

  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  const response = await fetch(`${API_BASE_URL}${url}`, {
    ...options,
    headers,
  });

  const data = await response.json();

  if (data.code !== 200) {
    throw new Error(data.message || '请求失败');
  }

  return data.data;
};

// 认证API
export const authApi = {
  // 登录
  login: async (username: string, password: string) => {
    const response = await request<{
      token: string;
      refreshToken: string;
      expiresIn: number;
      userInfo: {
        userId: number;
        username: string;
        nickname: string;
      };
    }>('/api/auth/login', {
      method: 'POST',
      body: JSON.stringify({ username, password }),
    });
    
    setToken(response.token);
    return response;
  },

  // 登出
  logout: () => {
    removeToken();
  },
};

// 积分API
export const pointsApi = {
  // 获取积分余额
  getBalance: async (): Promise<number> => {
    return request<number>('/api/points/balance');
  },

  // 获取积分明细
  getRecords: async (
    type: 'all' | 'earned' | 'spent' = 'all',
    timeRange: '30days' | '3months' | '12months' | '2years' = '30days'
  ) => {
    return request<any[]>(
      `/api/points/records?type=${type}&timeRange=${timeRange}`
    );
  },

  // 兑换产品
  exchange: async (
    productId: number,
    quantity: number,
    verificationCode: string
  ) => {
    return request<void>('/api/points/exchange', {
      method: 'POST',
      body: JSON.stringify({
        productId,
        quantity,
        verificationCode,
      }),
    });
  },
};

// 产品API
export const productApi = {
  // 获取产品列表
  getProducts: async () => {
    return request<any[]>('/api/products');
  },

  // 获取产品详情
  getProduct: async (id: number) => {
    return request<any>(`/api/products/${id}`);
  },
};
```

## 修改前端组件

### 1. 修改 PointsExchange.tsx

```typescript
import { useState, useEffect } from "react";
import { pointsApi, productApi } from "../services/api";
// ... 其他导入

export function PointsExchange({ onNavigateToDetail, onBack }: PointsExchangeProps) {
  const [products, setProducts] = useState<Product[]>([]);
  const [currentPoints, setCurrentPoints] = useState(0);
  const [selectedProduct, setSelectedProduct] = useState<Product | null>(null);
  // ... 其他状态

  // 加载产品列表和积分余额
  useEffect(() => {
    const loadData = async () => {
      try {
        const [productsData, balance] = await Promise.all([
          productApi.getProducts(),
          pointsApi.getBalance(),
        ]);
        setProducts(productsData);
        setCurrentPoints(balance);
      } catch (error) {
        toast.error("加载数据失败", {
          description: error instanceof Error ? error.message : "未知错误",
        });
      }
    };
    loadData();
  }, []);

  // 处理最终确认兑换
  const handleFinalConfirm = async () => {
    if (verificationCode !== "123456") {
      toast.error("验证码错误", {
        description: "请输入正确的验证码",
      });
      return;
    }

    if (!selectedProduct) return;

    setIsLoading(true);
    try {
      await pointsApi.exchange(
        selectedProduct.id,
        quantity,
        verificationCode
      );
      
      setIsConfirmDialogOpen(false);
      setVerificationCode("");
      
      // 刷新数据
      const [productsData, balance] = await Promise.all([
        productApi.getProducts(),
        pointsApi.getBalance(),
      ]);
      setProducts(productsData);
      setCurrentPoints(balance);
      
      toast.success("恭喜兑换成功！", {
        description: "优惠券将在24小时内发放至您的账户",
        duration: 3000,
      });
    } catch (error) {
      toast.error("兑换失败", {
        description: error instanceof Error ? error.message : "未知错误",
      });
    } finally {
      setIsLoading(false);
    }
  };

  // ... 其他代码
}
```

### 2. 修改 PointsDetail.tsx

```typescript
import { useState, useEffect } from "react";
import { pointsApi } from "../services/api";
// ... 其他导入

export function PointsDetail({ onBack }: PointsDetailProps) {
  const [records, setRecords] = useState<PointsRecord[]>([]);
  const [currentBalance, setCurrentBalance] = useState(0);
  const [pointsType, setPointsType] = useState<PointsType>("all");
  const [timeRange, setTimeRange] = useState<TimeRange>("30days");
  // ... 其他状态

  // 加载积分明细和余额
  useEffect(() => {
    const loadData = async () => {
      try {
        const [recordsData, balance] = await Promise.all([
          pointsApi.getRecords(pointsType, timeRange),
          pointsApi.getBalance(),
        ]);
        setRecords(recordsData);
        setCurrentBalance(balance);
      } catch (error) {
        toast.error("加载数据失败", {
          description: error instanceof Error ? error.message : "未知错误",
        });
      }
    };
    loadData();
  }, [pointsType, timeRange]);

  // ... 其他代码
}
```

### 3. 创建登录组件（可选）

如果需要登录功能，创建 `src/app/components/Login.tsx`:

```typescript
import { useState } from "react";
import { authApi } from "../services/api";
import { Button } from "./ui/button";
import { Input } from "./ui/input";
import { Card } from "./ui/card";
import { toast } from "sonner";

interface LoginProps {
  onLoginSuccess?: () => void;
}

export function Login({ onLoginSuccess }: LoginProps) {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      await authApi.login(username, password);
      toast.success("登录成功");
      onLoginSuccess?.();
    } catch (error) {
      toast.error("登录失败", {
        description: error instanceof Error ? error.message : "未知错误",
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <Card className="p-6 w-full max-w-md">
        <h2 className="text-2xl font-bold mb-6 text-center">登录</h2>
        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-2">用户名</label>
            <Input
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              placeholder="请输入用户名"
              required
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-2">密码</label>
            <Input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="请输入密码"
              required
            />
          </div>
          <Button type="submit" className="w-full" disabled={loading}>
            {loading ? "登录中..." : "登录"}
          </Button>
        </form>
      </Card>
    </div>
  );
}
```

## 配置代理（开发环境）

如果前端运行在不同端口，可以在 `vite.config.ts` 中配置代理：

```typescript
import { defineConfig } from 'vite'
import path from 'path'
import tailwindcss from '@tailwindcss/vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [
    react(),
    tailwindcss(),
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
      },
    },
  },
})
```

然后修改 `api.ts` 中的 `API_BASE_URL`：

```typescript
const API_BASE_URL = ''; // 使用相对路径，通过代理转发
```

## 错误处理

建议创建一个错误处理中间件：

```typescript
// src/services/api.ts 中添加
const request = async <T>(
  url: string,
  options: RequestInit = {}
): Promise<T> => {
  const token = getToken();
  const headers: HeadersInit = {
    'Content-Type': 'application/json',
    ...options.headers,
  };

  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  try {
    const response = await fetch(`${API_BASE_URL}${url}`, {
      ...options,
      headers,
    });

    const data = await response.json();

    // Token过期，清除并跳转登录
    if (data.code === 401) {
      removeToken();
      window.location.href = '/login';
      throw new Error('登录已过期，请重新登录');
    }

    if (data.code !== 200) {
      throw new Error(data.message || '请求失败');
    }

    return data.data;
  } catch (error) {
    if (error instanceof Error) {
      throw error;
    }
    throw new Error('网络错误，请稍后重试');
  }
};
```

## 测试

1. 启动后端服务（参考启动指南）
2. 启动前端服务：`npm run dev`
3. 测试各个功能：
   - 登录
   - 查看产品列表
   - 查看积分余额
   - 查看积分明细
   - 兑换产品

